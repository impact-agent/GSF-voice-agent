<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Talk to our AI Agent</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --blue:#2f64e1; --green:#22c55e; --red:#ef4444; --ink:#0b1220; --paper:#0f172a; --text:#e5e7eb; }
    body {
      margin:0;
      background:var(--paper);
      color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      display:grid;
      place-items:center;
      padding:28px;
    }
    .card {
      width:min(860px,94vw);
      background:#0c1324;
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:22px;
      box-shadow:0 10px 35px rgba(0,0,0,.35);
    }
    h1 { margin:0 0 10px; font-size:22px; }
    .note {
      color: var(--text);
      display: inline-block;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.05);
    }
    .row {
      margin:16px 0;
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    button {
      padding:12px 18px;
      border-radius:12px;
      font-size:16px;
      border:none;
      cursor:pointer;
      color:#fff;
    }
    #callBtn { background:var(--green); }
    #hangBtn { background:var(--red); display:none; }
    #status { margin-top:8px; opacity:.95; }
    #log {
      margin-top:14px;
      display:none;
      background:var(--ink);
      color:#e5e7eb;
      padding:12px;
      border-radius:10px;
      overflow:auto;
      max-height:40vh;
    }
    .pill {
      font-size:12px;
      background:#1b2a55;
      border:1px solid #274080;
      border-radius:999px;
      padding:4px 8px;
      margin-left:8px;
    }
  </style>
</head>
<body>
  <main class="card">
    <h1>ImpactAgent - GSF voice agent<span id="sdkSource" class="pill" style="display:none"></span></h1>
    <div class="note">
      Click "Start Call", then <em>ALLOW microphone access</em> when prompted.<br>
      If no prompt appears, click the lock icon in your browser's address bar and enable microphone permissions.<br>
      Keep this tab active during the call for best connection quality.
    </div>

    <div class="row">
      <button id="callBtn">Start Call</button>
      <button id="hangBtn">Hang Up</button>
      <span id="status">Loading agent…</span>
    </div>

    <pre id="log"></pre>
  </main>

  <!-- Everything below runs as an ES module (browser-native; no require()). -->
  <script type="module">
    // ✅ Import browser bundle with dependencies inlined.
    import { RetellWebClient } from "https://esm.sh/retell-client-js-sdk@2.0.7?bundle";

    // ---- Config: your Cloudflare Worker that returns {access_token, call_id}
    const MINT_URL = "https://gsf-voice-agent.jocelyn-379.workers.dev/"; // CHANGE if needed

    // ---- UI helpers
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const callBtn = document.getElementById('callBtn');
    const hangBtn = document.getElementById('hangBtn');

    function setStatus(t) {
      statusEl.textContent = t;
    }

    function log(message) {
      console.log(`[${new Date().toLocaleTimeString()}] ${message}`);
      // If you want on-page logs, uncomment below:
      // logEl.style.display = 'block';
      // logEl.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
    }

    // ---- Mobile throttling prevention
    let wakeLock = null;
    async function preventMobileThrottling() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
        }
      } catch (e) {
        log('Wake lock not supported');
      }
    }

    // ---- Connection monitoring
    let healthCheck;
    let reconnectAttempts = 0;

    function startHealthCheck() {
      healthCheck = setInterval(() => {
        if (inCall) log('Connection active');
      }, 20000);
    }

    function stopHealthCheck() {
      if (healthCheck) {
        clearInterval(healthCheck);
        healthCheck = null;
      }
    }

    // ---- Init SDK client
    let client = null;
    let inCall = false;
    let userRequestedHangup = false; // track explicit user hangup

    try {
      client = new RetellWebClient();

      client.on('call_started', () => {
        log('Call started successfully');
        setStatus("Connected. You can speak now.");
        startHealthCheck();
        reconnectAttempts = 0;
        inCall = true;
      });

      client.on('call_ended', (event) => {
        const reason = event?.reason || 'unknown';
        log(`Call ended: ${reason}`);
        stopHealthCheck();

        // Auto-reconnect only on network/connection issues, not on user hangup
        if (!userRequestedHangup && inCall && !reason.includes('user') && reconnectAttempts < 2) {
          reconnectAttempts++;
          log(`Auto-reconnect attempt ${reconnectAttempts}`);
          setStatus("Connection dropped. Trying to reconnect…");
          setTimeout(() => startCall(), 3000);
          return;
        }

        // Final clean-up: no more reconnects
        inCall = false;
        reconnectAttempts = 0;

        // Reset UI buttons
        hangBtn.style.display = 'none';
        callBtn.style.display = 'inline-block';

        if (userRequestedHangup) {
          setStatus("Call ended. Thank you — your responses have been recorded. You can close this tab or start a new call.");
          log("User-ended call; no auto-reconnect.");
        } else {
          setStatus("Connection ended. Please click 'Start Call' to try again.");
          log("Non-user call end; no further auto-reconnect.");
        }

        // Release wake lock if held
        if (wakeLock) {
          wakeLock.release().catch(() => {});
          wakeLock = null;
        }
      });

      client.on('error', (error) => {
        log(`Error: ${error.type} - ${error.message}`);
      });

      setStatus("Ready.");
    } catch (e) {
      setStatus("Could not initialize the agent SDK.");
      log("SDK init failed: " + e.message);
    }

    // ---- Fetch token from Worker
    async function mintToken() {
      const r = await fetch(MINT_URL, { method: 'POST' });
      const text = await r.text();
      try {
        const data = JSON.parse(text);
        return data;
      } catch (e) {
        log("Token fetch failed: response was not valid JSON");
        throw new Error("Could not get a token. Check Worker/AGENT_ID/API key.");
      }
    }

    // ---- Call controls

    async function startCall() {
      try {
        if (!client) throw new Error("SDK not ready");
        callBtn.disabled = true;
        userRequestedHangup = false; // reset flag on new call

        // Detect device type and prevent mobile issues
        const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
        log(`Starting call on ${isMobile ? 'mobile' : 'desktop'}`);

        if (isMobile) {
          await preventMobileThrottling();
        }

        setStatus("Connecting… please allow microphone");

        const { access_token, call_id } = await mintToken();
        if (!access_token) throw new Error("No access_token returned from Worker");

        await client.startCall({
          accessToken: access_token,
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        });

        inCall = true;
        callBtn.style.display = 'none';
        hangBtn.style.display = 'inline-block';
        log(`Call ID: ${call_id}`);

      } catch (e) {
        setStatus(e.message || "Error starting call.");
        log("Start call error: " + e.message);
        // On failure, reset UI so user can try again
        inCall = false;
        hangBtn.style.display = 'none';
        callBtn.style.display = 'inline-block';
      } finally {
        callBtn.disabled = false;
      }
    }

    function endCall() {
      // Explicit user hangup
      userRequestedHangup = true;
      try {
        client?.stopCall?.();
      } catch (_) {
        // ignore
      }

      // We let call_ended handler do final clean-up,
      // but ensure state is already reset.
      inCall = false;
      reconnectAttempts = 0;
      stopHealthCheck();

      // Immediate UI feedback
      hangBtn.style.display = 'none';
      callBtn.style.display = 'inline-block';
      setStatus("Ending call… Thank you — your responses have been recorded.");
      log("User ended call");

      if (wakeLock) {
        wakeLock.release().catch(() => {});
        wakeLock = null;
      }
    }

    callBtn.addEventListener('click', () => {
      if (!inCall) startCall();
    });

    hangBtn.addEventListener('click', endCall);
  </script>
</body>
</html>
